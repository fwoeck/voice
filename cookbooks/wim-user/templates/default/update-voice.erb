#!/bin/zsh

echo 'This will -> stop all running voice daemons, -> CLEAR'
echo 'all uncommited changes, -> pull the GH repos, -> bundle'
echo 'their gems, -> migrate the DB and finally -> restart sv.'

read -q "response?Are you sure? [y/N] "
if [[ $response =~ ^(Y|y)$ ]]; then
  echo
  source <%= node[:rvm][:basedir] %>/scripts/rvm
  sudo sv down /etc/service/*
  ls -1d /opt/voice-* | while read name; do cd $name; git reset --hard; git pull; bundle install --no-binstubs >/dev/null; done
  cd <%= node[:voice_rails][:basedir] %>
  rake db:migrate
  sudo sv up /etc/service/*
fi
