#!/bin/zsh
set -e

cd <%= node[:voice_rails][:basedir] %> || :
source <%= node[:rvm][:basedir] %>/scripts/rvm
newrelease=0.0.$(($(git tag | sort | tail -1 | cut -d. -f3)+1))

echo "This will create the release version $newrelease for all projects."
echo "Make sure, you have no uncommitted changes in VR, VA, VN or VP and"
echo "all development branches can be cleanly merged into master."

read -q "resp1?Should we proceed? [y/N] "
if [[ $resp1 =~ ^(Y|y)$ ]]; then
  echo

  for project in "<%= node[:voice_rails][:basedir] %>" "<%= node[:voice_ahn][:basedir] %>" "<%= node[:voice_custom][:basedir] %>" "<%= node[:voice_push][:basedir] %>" "<%= node[:voice_numbers][:basedir] %>"
  do
    echo
    echo ">> Preparing $project"
    echo
    cd $project || :
    git checkout master
    git pull
    git checkout develop
    git flow release start $newrelease
    sleep 1
    git flow release finish --nobackmerge --fetch --push --message $newrelease $newrelease
    sleep 1
    git checkout develop
    git merge master -m "Back-merged master from release #{$newrelease}"
    git push
  done
fi

echo
echo "Ok, all done."
read -q "resp2?Do you want to precompile and sync the rails assets? [y/N] "
if [[ $resp2 =~ ^(Y|y)$ ]]; then
  echo

  cd <%= node[:voice_rails][:basedir] %> || :
  RAILS_ENV=production rake assets:precompile
  rsync --delete -a ./public/assets wim@voice.dokmatic.com:<%= node[:voice_rails][:basedir] %>/public
  rm -rf public/assets/*
fi

echo
echo "Fine, now go to wim@voice.dokmatic.com and launch update-voice."
